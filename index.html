<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Dashboard de Llegada de Camiones</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { 
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      min-height: 100vh;
    }
    .dashboard-container { 
      padding: 2rem; 
      margin: 0; 
      max-width: 1400px;
      margin: 0 auto;
    }
    .btn-group-sm>.btn, .btn-sm {
    background-color: #343a40;
    color: #fff;
    --bs-btn-padding-y: 0.25rem;
    --bs-btn-padding-x: 0.5rem;
    --bs-btn-font-size: 0.875rem;
    --bs-btn-border-radius: var(--bs-border-radius-sm);
}
    .card { 
      border-radius: 1rem; 
      border: none;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      margin-bottom: 1.5rem;
    }
    .card-header {
      background-color: #0d6efd;
      color: white;
      border-radius: 1rem 1rem 0 0 !important;
      padding: 1rem 1.5rem;
      font-weight: 600;
    }
    #tablaCamiones th, #tablaCamiones td { 
      text-align: center; 
      vertical-align: middle;
      padding: 0.75rem;
    }
    #tablaCamiones thead th {
      background-color: #f8f9fa;
      border-bottom: 2px solid #dee2e6;
      font-weight: 600;
      color: #495057;
    }
    #tablaCamiones tbody tr:hover {
      background-color: #f8f9fa;
      cursor: pointer;
    }
    .badge-carril {
      background-color: #e7f1ff;
      color: #0d6efd;
      font-weight: 500;
      padding: 0.25rem 0.5rem;
      border-radius: 0.25rem;
    }
    .btn-primary {
      background-color: #0d6efd;
      border-color: #0d6efd;
      padding: 0.5rem 1rem;
      font-weight: 500;
    }
    .btn-primary:hover {
      background-color: #0b5ed7;
      border-color: #0a58ca;
      transform: translateY(-1px);
      transition: all 0.2s;
    }
    .form-control, .form-select {
      border: 1px solid #ced4da;
      border-radius: 0.375rem;
      padding: 0.5rem 0.75rem;
    }
    .form-control:focus, .form-select:focus {
      border-color: #86b7fe;
      box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }
    .empty-table-message {
      text-align: center;
      color: #6c757d;
      font-style: italic;
      padding: 2rem;
    }
    .carril-seleccionado {
      border: 2px solid #0d6efd !important;
      box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
    }
    .alert-success {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      animation: slideIn 0.3s ease-out, fadeOut 0.5s ease-out 2.5s forwards;
      border-radius: 0.5rem;
    }
    
    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    @keyframes fadeOut {
      to {
        opacity: 0;
        transform: translateX(100%);
      }
    }
    
    /* Estilos para el esc√°ner */
    .scanner-container {
      position: relative;
      border: 2px dashed #0d6efd;
      border-radius: 10px;
      overflow: hidden;
      background: #f8f9fa;
    }
    
    #scannerVideo {
      width: 100%;
      height: 300px;
      object-fit: cover;
    }
    
    .scanner-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, 0.7);
      color: white;
    }
    
    .scanner-frame {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 250px;
      height: 250px;
      border: 3px solid #0d6efd;
      border-radius: 10px;
      box-shadow: 0 0 0 1000px rgba(0, 0, 0, 0.5);
    }
    
    .scanner-laser {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 2px;
      background: #ff0000;
      box-shadow: 0 0 8px rgba(255, 0, 0, 0.6);
      animation: scan 2s infinite linear;
    }
    
    @keyframes scan {
      0% { top: 0; }
      50% { top: 100%; }
      100% { top: 0; }
    }
    
    .barcode-input {
      font-family: 'Courier New', monospace;
      letter-spacing: 1px;
    }
    
    .status-indicator {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 5px;
    }
    
    .status-active {
      background-color: #198754;
      animation: pulse 1s infinite;
    }
    
    .status-inactive {
      background-color: #dc3545;
    }
    
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }
    
    .auto-registro-indicator {
      position: absolute;
      top: -10px;
      right: -10px;
      background-color: #198754;
      color: white;
      border-radius: 50%;
      width: 25px;
      height: 25px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      z-index: 2;
    }
    
    .quick-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 15px;
    }
    
    .quick-action-btn {
      flex: 1;
      min-width: 120px;
    }
    
    .manual-mode .form-control,
    .manual-mode .form-select {
      border-color: #ffc107;
      background-color: #fff9e6;
    }
    
    .auto-mode .form-control,
    .auto-mode .form-select {
      border-color: #198754;
      background-color: #e8f5e9;
    }
    
    .error-mode .form-control,
    .error-mode .form-select {
      border-color: #dc3545;
      background-color: #ffe6e6;
      animation: shake 0.5s;
    }
    
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
      20%, 40%, 60%, 80% { transform: translateX(5px); }
    }
    
    .duplicate-highlight {
      animation: highlight 2s;
      background-color: rgba(220, 53, 69, 0.1);
    }
    
    @keyframes highlight {
      0% { background-color: rgba(220, 53, 69, 0.3); }
      100% { background-color: transparent; }
    }
    
    .camion-duplicado {
      background-color: #fff3cd !important;
      border-left: 4px solid #ffc107;
    }
    
    .registro-duplicado {
      border: 2px solid #dc3545 !important;
      box-shadow: 0 0 10px rgba(220, 53, 69, 0.3);
    }
    
    .auto-mode-indicator {
      position: absolute;
      top: 5px;
      right: 5px;
      background: #198754;
      color: white;
      padding: 2px 8px;
      border-radius: 3px;
      font-size: 0.7rem;
    }
    
    .duplicate-warning {
      border: 2px solid #ffc107;
      background-color: #fff3cd;
      border-radius: 5px;
      padding: 10px;
      margin-top: 10px;
    }
    
    /* Estilo especial para ruta "santa fe 3" */
    .ruta-santa-fe-3 {
      background-color: rgba(25, 135, 84, 0.15) !important;
      border-left: 4px solid #198754 !important;
      border-right: 4px solid #198754 !important;
    }
    
    .ruta-santa-fe-3 td:nth-child(3) { /* Columna de Ruta */
      background-color: rgba(25, 135, 84, 0.2);
      font-weight: bold;
      color: #198754 !important;
      position: relative;
    }
    
    .ruta-santa-fe-3 td:nth-child(3)::after {
      content: "üü¢";
      position: absolute;
      right: 5px;
    }
    
    /* Estilo especial para tipo "Apoyo" - COLOR ROJO */
    .tipo-apoyo {
      background-color: rgba(220, 53, 69, 0.15) !important;
      border-left: 4px solid #dc3545 !important;
      border-right: 4px solid #dc3545 !important;
      animation: pulseRed 2s infinite;
    }
    
    .tipo-apoyo td:nth-child(5) { /* Columna de Tipo de Carga */
      background-color: rgba(220, 53, 69, 0.2);
      font-weight: bold;
      color: #dc3545 !important;
      position: relative;
    }
    
    .tipo-apoyo td:nth-child(5)::after {
      
      position: absolute;
      right: 5px;
    }
    
    @keyframes pulseRed {
      0% { background-color: rgba(220, 53, 69, 0.1); }
      50% { background-color: rgba(220, 53, 69, 0.2); }
      100% { background-color: rgba(220, 53, 69, 0.1); }
    }
    
    .badge-ruta-especial {
      background-color: #198754 !important;
      color: white !important;
      font-weight: bold;
      animation: pulse 1.5s infinite;
    }
    
    .badge-tipo-apoyo {
      background-color: #dc3545 !important;
      color: white !important;
      font-weight: bold;
      animation: pulse 1.5s infinite;
    }
    
    .route-highlight {
      background: linear-gradient(90deg, rgba(25, 135, 84, 0.1), rgba(25, 135, 84, 0.2), rgba(25, 135, 84, 0.1));
      border-radius: 4px;
      padding: 2px 8px;
      display: inline-block;
    }
    
    .tipo-apoyo-highlight {
      background: linear-gradient(90deg, rgba(220, 53, 69, 0.1), rgba(220, 53, 69, 0.2), rgba(220, 53, 69, 0.1));
      border-radius: 4px;
      padding: 2px 8px;
      display: inline-block;
    }
    
    /* Estilo para formulario cuando es tipo Apoyo */
    .apoyo-mode .form-control,
    .apoyo-mode .form-select {
      border-color: #dc3545;
      background-color: #ffe6e6;
    }
    
    .form-apoyo-indicator {
      position: absolute;
      top: 5px;
      right: 5px;
      background: #dc3545;
      color: white;
      padding: 2px 8px;
      border-radius: 3px;
      font-size: 0.7rem;
    }
  </style>
</head>
<body>



<div class="container-fluid dashboard-container">
  <h2 class="text-center mb-4" style="color: #0d6efd;">üöõ Dashboard de Llegada de Camiones</h2>

  <!-- Esc√°ner de c√≥digo de barras -->
  <div class="card shadow mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
      <span>üì∑ Esc√°ner de C√≥digo de Barras/QR</span>
      <div>
        <span class="status-indicator" id="scannerStatus"></span>
        <small id="scannerStatusText">Listo para escanear</small>
      </div>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-8">
          <div class="scanner-container" id="scannerContainer">
            <video id="scannerVideo"></video>
            <div class="scanner-frame">
              <div class="scanner-laser"></div>
            </div>
            <div class="scanner-overlay" id="scannerOverlay">
              <h4>üîç Esc√°ner de C√≥digos</h4>
              <p class="text-center">Coloca el c√≥digo de barras dentro del marco</p>
              <button class="btn btn-primary mt-3" onclick="startScanner()">
                ‚ñ∂Ô∏è Iniciar Esc√°ner
              </button>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="mb-3">
            <label class="form-label fw-semibold">üìã Entrada Manual de C√≥digo</label>
            <input type="text" 
                   class="form-control barcode-input" 
                   id="barcodeInput" 
                   placeholder="Ej: Rusa-421-Santa fe 3-2-Apoyo"
                   autocomplete="off">
            <div class="form-text">Presiona Enter despu√©s de escribir el c√≥digo (se registrar√° autom√°ticamente)</div>
          </div>
          
          <div class="quick-actions">
          
            <a href="dashboard.html"> <button  class="btn btn-outline-secondary">Dashboard</button> </a>
           
            <button class="btn btn-outline-danger quick-action-btn" onclick="testCode('Rusa-999-Otra ruta-5-Apoyo')">
              üî¥ Solo Apoyo
            </button>
          </div>
          
          <div class="mt-3">
            <h6>üìù Formato del C√≥digo:</h6>
            <code>Prefijo-Numero-Ruta-Carril-TipoCarga</code>
            <ul class="small mt-2">
              <li><strong>Prefijo</strong>: Rusa, TRK, Cam, etc.</li>
              <li><strong>Numero</strong>: N√∫mero de cami√≥n (ej: 421)</li>
              <li><strong>Ruta</strong>: Nombre de ruta (ej: Santa fe 3)</li>
              <li><strong>Carril</strong>: N√∫mero de carril (1-10)</li>
              <li><strong>TipoCarga</strong>: Tipo  (Apoyo, Titular, etc.)</li>
            </ul>
            
            <div class="alert alert-danger small">
              <strong>‚ö†Ô∏è Tipos Especiales:</strong> 
              <span class="badge bg-danger">Apoyo</span> se resalta en <strong>rojo</strong>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Formulario -->
  <div class="card shadow">
    <div class="card-header d-flex justify-content-between align-items-center">
      <span>üìù Registrar Nueva Llegada</span>
      <div>
        <span id="registroMode" class="badge bg-info">Modo Manual</span>
        <span id="tipoApoyoIndicator" class="badge bg-danger d-none">Tipo: Apoyo</span>
      </div>
    </div>
    <div class="card-body">
      <form id="camionForm">
        <div class="row g-3">
          <div class="col-md-2">
            <label class="form-label fw-semibold">N√∫mero de Cami√≥n</label>
            <input type="text" class="form-control" id="numeroCamion" 
                   placeholder="Ej: 421" pattern="[0-9]+" title="Solo n√∫meros">
            <div class="invalid-feedback" id="errorNumeroCamion">
              Este cami√≥n ya est√° registrado y activo
            </div>
          </div>
          <div class="col-md-3">
            <label class="form-label fw-semibold">Nombre de Ruta</label>
            <input type="text" class="form-control" id="nombreRuta" 
                   placeholder="Ej: Santa fe 3">
            <div class="form-text">Nota: "Santa Fe 3" se resaltar√° en verde</div>
          </div>
          <div class="col-md-2">
            <label class="form-label fw-semibold">Carril</label>
            <select class="form-select" id="carril">
              <option value="">Seleccionar...</option>
              <option value="1">Carril 1 (A)</option>
              <option value="2">Carril 2 (B)</option>
              <option value="3">Carril 3 (C)</option>
              <option value="4">Carril 4 (D)</option>
              <option value="5">Carril 5 (E)</option>
              <option value="6">Carril 6 (F)</option>
              <option value="7">Carril 7 (G)</option>
              <option value="8">Carril 8 (H)</option>
              <option value="9">Carril 9 (I)</option>
              <option value="10">Carril 10 (J)</option>
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label fw-semibold">Tipo de Carga</label>
            <input type="text" class="form-control" id="tipoCarga" 
                   placeholder="Ej: Apoyo, 32, etc.">
            <div class="form-text">"Apoyo" resaltar√° en rojo</div>
          </div>
          <div class="col-md-3 d-flex align-items-end gap-2">
            <button type="submit" class="btn btn-primary w-100" id="btnRegistrar">
              <span style="font-size: 1.2rem;">‚úì</span> Registrar Manual
            </button>
            <button type="button" class="btn btn-outline-secondary" onclick="limpiarFormulario()">
              <span style="font-size: 1.2rem;">üóëÔ∏è</span> Limpiar
            </button>
          </div>
        </div>
        
        <!-- Mensaje de error para duplicados -->
        <div id="duplicateWarning" class="duplicate-warning mt-3" style="display: none;">
          <div class="d-flex align-items-center">
            <span style="font-size: 1.5rem; margin-right: 10px;">‚ö†Ô∏è</span>
            <div>
              <strong>Cami√≥n duplicado detectado</strong>
              <div id="duplicateDetails" class="small"></div>
            </div>
            <button type="button" class="btn btn-sm btn-outline-warning ms-auto" onclick="registrarSalidaDuplicado()">
              Registrar Salida Primero
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Tabla -->
  <div class="card shadow mt-4">
    <div class="card-header d-flex justify-content-between align-items-center">
      <span>üìã Historial de Llegadas</span>
      <div>
        <button class="btn btn-outline-danger btn-sm" onclick="limpiarHistorial()">
          üóëÔ∏è Limpiar Historial
        </button>
        <button class="btn btn-outline-info btn-sm ms-2" onclick="exportarDatos()">
          üì§ Exportar
        </button>
       
        <button class="btn btn-outline-danger btn-sm ms-2" onclick="filtrarTipoApoyo()">
          üî¥ Mostrar Apoyo
        </button>
        <button class="btn btn-outline-secondary btn-sm ms-2" onclick="quitarFiltros()">
          üìã Mostrar Todo
        </button>
      </div>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover" id="tablaCamiones">
          <thead>
            <tr>
              <th>#</th>
              <th>Numero de Camion</th>
              <th>Ruta</th>
              <th>Carril</th>
              <th>Tipo</th>
              <th>Hora de Llegada</th>
              <th>Hora de Salida</th>
              <th>Estado</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="tablaBody">
            <!-- Las filas se generan din√°micamente -->
          </tbody>
        </table>
        <div id="emptyMessage" class="empty-table-message" style="display: none;">
          No hay camiones registrados. ¬°Escanea el primer c√≥digo!
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Incluir biblioteca para escanear c√≥digos de barras/QR -->
<script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.19.1"></script>

<script>
  // Variables globales
  let codeReader = null;
  let scannerActive = false;
  let lastScannedCode = '';
  let modoActual = 'manual'; // 'manual' o 'auto'
  let camionDuplicado = null; // Para almacenar datos del cami√≥n duplicado
  let filtroActivo = 'todos'; // 'todos', 'santa-fe-3', 'apoyo'

  // Prefijos v√°lidos para registro autom√°tico
  const prefijosValidos = ['RUSA', 'TRK', 'CAM', 'TRA', 'TRUCK', 'TCK', 'CT'];

  // Mapa para convertir n√∫mero de carril a letra
  const mapaCarriles = {
    "1": "A", "2": "B", "3": "C", "4": "D",
    "5": "E", "6": "F", "7": "G", "8": "H",
    "9": "I", "10": "J"
  };

  // Funci√≥n para verificar si es ruta "santa fe 3"
  function esRutaSantaFe3(nombreRuta) {
    if (!nombreRuta) return false;
    
    // Convertir a min√∫sculas y limpiar espacios
    const rutaLimpia = nombreRuta.toLowerCase().trim();
    
    // Verificar variaciones de "santa fe 3"
    return rutaLimpia.includes('santa fe 3') || 
           rutaLimpia === 'santa fe 3' ||
           rutaLimpia.includes('santa fe3') ||
           rutaLimpia.includes('santa-fe-3') ||
           rutaLimpia.includes('santafe3');
  }

  // Funci√≥n para verificar si es tipo "Apoyo"
  function esTipoApoyo(tipoCarga) {
    if (!tipoCarga) return false;
    
    // Convertir a min√∫sculas y limpiar espacios
    const tipoLimpio = tipoCarga.toLowerCase().trim();
    
    // Verificar variaciones de "apoyo"
    return tipoLimpio === 'apoyo' ||
           tipoLimpio.includes('apoyo') ||
           tipoLimpio === 'soporte' ||
           tipoLimpio.includes('soporte');
  }

  // Funci√≥n para verificar si un cami√≥n est√° duplicado
  function verificarDuplicado(numeroCamion) {
    const camiones = JSON.parse(localStorage.getItem("camiones") || "[]");
    return camiones.find(c => 
      c.numeroCamion === numeroCamion && c.horaSalida === "‚Äî"
    );
  }

  // Mostrar error de duplicado en formulario
  function mostrarErrorDuplicado(camionExistente, esAutomatico = false) {
    const formContainer = document.getElementById('camionForm').parentElement;
    const inputNumero = document.getElementById('numeroCamion');
    const errorDiv = document.getElementById('errorNumeroCamion');
    const duplicateWarning = document.getElementById('duplicateWarning');
    const duplicateDetails = document.getElementById('duplicateDetails');
    
    // Guardar datos del cami√≥n duplicado
    camionDuplicado = camionExistente;
    
    // Cambiar a modo error
    formContainer.classList.remove('manual-mode', 'auto-mode', 'apoyo-mode');
    formContainer.classList.add('error-mode');
    
    // Marcar input como inv√°lido
    inputNumero.classList.add('is-invalid');
    
    // Mostrar detalles del duplicado
    const letraCarril = mapaCarriles[camionExistente.carril] || camionExistente.carril;
    duplicateDetails.innerHTML = `
      Cami√≥n #${camionExistente.numeroCamion} ya est√° activo en <strong>Carril ${letraCarril}</strong><br>
      Ruta: ${camionExistente.nombreRuta} | Llegada: ${camionExistente.horaLlegada}
    `;
    
    // Mostrar advertencia
    duplicateWarning.style.display = 'block';
    
    // Mostrar notificaci√≥n
    const mensaje = esAutomatico ? 
      `‚ö†Ô∏è C√≥digo escaneado: Cami√≥n ${numeroCamion} ya est√° registrado y activo` :
      `‚ö†Ô∏è Cami√≥n ${numeroCamion} ya est√° registrado y activo`;
    
    mostrarNotificacion(mensaje, 'warning');
    
    // Resaltar el cami√≥n duplicado en la tabla
    resaltarCamionDuplicado(camionExistente.numeroCamion);
    
    return false;
  }

  // Resaltar cami√≥n duplicado en la tabla
  function resaltarCamionDuplicado(numeroCamion) {
    const filas = document.querySelectorAll('#tablaBody tr');
    filas.forEach(fila => {
      const celdaNumero = fila.querySelector('td:nth-child(2)');
      if (celdaNumero && celdaNumero.textContent.includes(numeroCamion)) {
        fila.classList.add('camion-duplicado');
        fila.classList.add('duplicate-highlight');
        
        // Hacer scroll a la fila
        fila.scrollIntoView({ behavior: 'smooth', block: 'center' });
        
        // Quitar resaltado despu√©s de 3 segundos
        setTimeout(() => {
          fila.classList.remove('duplicate-highlight');
        }, 3000);
      }
    });
  }

  // Limpiar error de duplicado
  function limpiarErrorDuplicado() {
    const formContainer = document.getElementById('camionForm').parentElement;
    const inputNumero = document.getElementById('numeroCamion');
    const duplicateWarning = document.getElementById('duplicateWarning');
    
    // Quitar clases de error
    formContainer.classList.remove('error-mode');
    inputNumero.classList.remove('is-invalid');
    
    // Ocultar advertencia
    duplicateWarning.style.display = 'none';
    
    // Limpiar variable
    camionDuplicado = null;
  }

  // Registrar salida del cami√≥n duplicado
  function registrarSalidaDuplicado() {
    if (!camionDuplicado) return;
    
    const camiones = JSON.parse(localStorage.getItem("camiones") || "[]");
    const index = camiones.findIndex(c => 
      c.numeroCamion === camionDuplicado.numeroCamion && 
      c.horaSalida === "‚Äî"
    );
    
    if (index !== -1) {
      const horaSalida = new Date().toLocaleTimeString();
      camiones[index].horaSalida = horaSalida;
      localStorage.setItem("camiones", JSON.stringify(camiones));
      
      mostrarNotificacion(`‚úÖ Salida registrada para cami√≥n ${camionDuplicado.numeroCamion}`);
      actualizarTabla();
      limpiarErrorDuplicado();
      
      // Si estamos en modo autom√°tico, proceder con el registro
      if (modoActual === 'auto') {
        const datosAuto = {
          numeroCamion: document.getElementById('numeroCamion').value.trim(),
          nombreRuta: document.getElementById('nombreRuta').value.trim(),
          carril: document.getElementById('carril').value,
          tipoCarga: document.getElementById('tipoCarga').value.trim()
        };
        
        setTimeout(() => {
          registrarCamion(datosAuto, true);
        }, 1000);
      }
    }
  }

  // Inicializar el esc√°ner
  function initScanner() {
    codeReader = new ZXing.BrowserQRCodeReader();
    updateScannerStatus('Listo para escanear', 'inactive');
  }

  // Iniciar el esc√°ner
  function startScanner() {
    const videoElement = document.getElementById('scannerVideo');
    const scannerOverlay = document.getElementById('scannerOverlay');
    
    if (!codeReader) {
      initScanner();
    }
    
    scannerOverlay.style.display = 'none';
    updateScannerStatus('Escaneando...', 'active');
    
    codeReader.decodeFromVideoDevice(null, videoElement, (result, error) => {
      if (result) {
        // C√≥digo detectado
        handleScannedCode(result.text);
      }
      
      if (error && !error.message.includes('NotFoundException')) {
        console.error('Error en esc√°ner:', error);
      }
    });
    
    scannerActive = true;
  }

  // Detener el esc√°ner
  function stopScanner() {
    if (codeReader && scannerActive) {
      codeReader.reset();
      scannerActive = false;
      
      const scannerOverlay = document.getElementById('scannerOverlay');
      scannerOverlay.style.display = 'flex';
      
      updateScannerStatus('Esc√°ner detenido', 'inactive');
    }
  }

  // Actualizar estado del esc√°ner
  function updateScannerStatus(text, status) {
    const statusIndicator = document.getElementById('scannerStatus');
    const statusText = document.getElementById('scannerStatusText');
    
    statusText.textContent = text;
    statusIndicator.className = 'status-indicator';
    statusIndicator.classList.add(status === 'active' ? 'status-active' : 'status-inactive');
  }

  // Manejar c√≥digo escaneado
  function handleScannedCode(code) {
    // Evitar procesar el mismo c√≥digo m√∫ltiples veces
    if (code === lastScannedCode) {
      return;
    }
    
    lastScannedCode = code;
    console.log('C√≥digo escaneado:', code);
    
    // Mostrar notificaci√≥n
    mostrarNotificacion(`C√≥digo detectado: ${code}`, 'info');
    
    // Procesar el c√≥digo
    procesarCodigoBarras(code);
    
    // Detener el esc√°ner temporalmente para evitar m√∫ltiples lecturas
    setTimeout(() => {
      lastScannedCode = '';
    }, 2000);
  }

  // Verificar si el c√≥digo tiene prefijo v√°lido
  function tienePrefijoValido(codigo) {
    const primeraParte = codigo.split('-')[0].toUpperCase();
    return prefijosValidos.includes(primeraParte);
  }

  // Procesar c√≥digo de barras
  function procesarCodigoBarras(codigo) {
    // Verificar si tiene prefijo para registro autom√°tico
    if (tienePrefijoValido(codigo)) {
      // Es un c√≥digo con prefijo, procesar para registro autom√°tico
      const datos = parsearCodigoConPrefijo(codigo);
      if (datos) {
        // Verificar si es ruta santa fe 3
        if (esRutaSantaFe3(datos.nombreRuta)) {
          mostrarNotificacion('üü¢ ¬°Tipo aTitular detectada! Se resaltar√° en verde.', 'success');
        }
        
        // Verificar si es tipo apoyo
        if (esTipoApoyo(datos.tipoCarga)) {
          mostrarNotificacion('üî¥ ¬°Tipo Apoyo detectado! Se resaltar√° en rojo.', 'warning');
        }
        
        // Verificar duplicado ANTES de cambiar a modo autom√°tico
        const duplicado = verificarDuplicado(datos.numeroCamion);
        if (duplicado) {
          // Mostrar error de duplicado en modo autom√°tico
          cambiarModoRegistro('manual'); // Cambiar a manual para mostrar error
          llenarFormulario(datos);
          mostrarErrorDuplicado(duplicado, true);
          return;
        }
        
        // Cambiar a modo autom√°tico (no hay duplicado)
        cambiarModoRegistro('auto');
        
        // Llenar formulario (solo para mostrar)
        llenarFormulario(datos);
        
        // Registrar autom√°ticamente despu√©s de breve delay
        setTimeout(() => {
          registrarCamion(datos, true);
        }, 500);
      }
    } else {
      // No tiene prefijo v√°lido, solo llenar formulario
      const datos = extraerDatosDeCodigo(codigo);
      if (datos.numeroCamion || datos.nombreRuta) {
        // Verificar si es ruta santa fe 3
        if (esRutaSantaFe3(datos.nombreRuta)) {
          mostrarNotificacion('üü¢ ¬°Ruta Titular detectada!', 'info');
        }
        
        // Verificar si es tipo apoyo
        if (esTipoApoyo(datos.tipoCarga)) {
          mostrarNotificacion('üî¥ ¬°Tipo Apoyo detectado!', 'warning');
        }
        
        // Verificar duplicado
        if (datos.numeroCamion) {
          const duplicado = verificarDuplicado(datos.numeroCamion);
          if (duplicado) {
            mostrarErrorDuplicado(duplicado, false);
          }
        }
        
        cambiarModoRegistro('manual');
        llenarFormulario(datos);
        mostrarNotificacion('C√≥digo procesado. Complete los datos y presione "Registrar Manual"', 'warning');
      } else {
        mostrarNotificacion('Formato de c√≥digo no reconocido. Ingrese datos manualmente.', 'danger');
      }
    }
  }

  // Parsear c√≥digo con prefijo
  function parsearCodigoConPrefijo(codigo) {
    const partes = codigo.split('-');
    
    if (partes.length < 4) {
      mostrarNotificacion('Formato de c√≥digo incompleto', 'warning');
      return null;
    }
    
    const datos = {
      numeroCamion: partes[1] || '',
      nombreRuta: partes[2] || '',
      carril: '',
      tipoCarga: partes[4] || ''
    };
    
    // Procesar carril (puede ser n√∫mero o letra)
    const carrilInput = partes[3] || '';
    if (carrilInput.match(/^[0-9]+$/)) {
      datos.carril = carrilInput;
    } else {
      // Convertir letra a n√∫mero
      for (const [num, letra] of Object.entries(mapaCarriles)) {
        if (letra === carrilInput.toUpperCase()) {
          datos.carril = num;
          break;
        }
      }
      // Si no se encuentra, usar como est√°
      if (!datos.carril && carrilInput) {
        datos.carril = carrilInput;
      }
    }
    
    // Convertir ruta a formato legible
    datos.nombreRuta = datos.nombreRuta.replace(/_/g, ' ').replace(/\b\w/g, l => l.toLowerCase());
    
    return datos;
  }

  // Extraer datos de c√≥digo sin prefijo espec√≠fico
  function extraerDatosDeCodigo(codigo) {
    const datos = {
      numeroCamion: '',
      nombreRuta: '',
      carril: '',
      tipoCarga: ''
    };
    
    // Intentar extraer n√∫mero de cami√≥n
    const numeroMatch = codigo.match(/\b(\d{2,4})\b/);
    if (numeroMatch) {
      datos.numeroCamion = numeroMatch[1];
    }
    
    // Intentar extraer otros datos
    const partes = codigo.split(/[-\s]+/);
    if (partes.length > 1) {
      // Buscar posible ruta (palabras despu√©s del n√∫mero)
      const palabras = codigo.split(/[^a-zA-Z0-9√°√©√≠√≥√∫√Å√â√ç√ì√ö√±√ë]+/);
      if (palabras.length > 1) {
        datos.nombreRuta = palabras.slice(1, 3).join(' ') || 'Ruta Desconocida';
      }
    }
    
    return datos;
  }

  // Llenar formulario con datos
  function llenarFormulario(datos) {
    document.getElementById('numeroCamion').value = datos.numeroCamion || '';
    document.getElementById('nombreRuta').value = datos.nombreRuta || '';
    document.getElementById('carril').value = datos.carril || '';
    document.getElementById('tipoCarga').value = datos.tipoCarga || '';
    
    // Aplicar estilos especiales seg√∫n tipo de carga
    aplicarEstilosFormulario(datos.tipoCarga, datos.nombreRuta);
    
    // Verificar duplicado al llenar
    if (datos.numeroCamion) {
      verificarDuplicadoEnTiempoReal(datos.numeroCamion);
    }
  }

  // Aplicar estilos al formulario seg√∫n tipo de carga y ruta
  function aplicarEstilosFormulario(tipoCarga, nombreRuta) {
    const formContainer = document.getElementById('camionForm').parentElement;
    const tipoApoyoIndicator = document.getElementById('tipoApoyoIndicator');
    const inputRuta = document.getElementById('nombreRuta');
    const inputTipoCarga = document.getElementById('tipoCarga');
    
    // Quitar clases anteriores
    formContainer.classList.remove('manual-mode', 'auto-mode', 'error-mode', 'apoyo-mode');
    tipoApoyoIndicator.classList.add('d-none');
    inputRuta.style.backgroundColor = '';
    inputRuta.style.borderColor = '';
    inputTipoCarga.style.backgroundColor = '';
    inputTipoCarga.style.borderColor = '';
    
    // Aplicar estilos seg√∫n tipo
    if (esTipoApoyo(tipoCarga)) {
      formContainer.classList.add('apoyo-mode');
      tipoApoyoIndicator.classList.remove('d-none');
      inputTipoCarga.style.backgroundColor = '#ffe6e6';
      inputTipoCarga.style.borderColor = '#dc3545';
    }
    
    // Aplicar estilos seg√∫n ruta
    if (esRutaSantaFe3(nombreRuta)) {
      inputRuta.style.backgroundColor = '#d4edda';
      inputRuta.style.borderColor = '#198754';
    }
  }

  // Verificar duplicado en tiempo real
  function verificarDuplicadoEnTiempoReal(numeroCamion) {
    if (!numeroCamion) return;
    
    const duplicado = verificarDuplicado(numeroCamion);
    if (duplicado) {
      mostrarErrorDuplicado(duplicado, false);
    } else {
      limpiarErrorDuplicado();
    }
  }

  // Cambiar modo de registro
  function cambiarModoRegistro(modo) {
    modoActual = modo;
    const formContainer = document.getElementById('camionForm').parentElement;
    const modoBadge = document.getElementById('registroMode');
    const btnRegistrar = document.getElementById('btnRegistrar');
    
    // Remover clases anteriores (excepto apoyo-mode si aplica)
    const esApoyo = formContainer.classList.contains('apoyo-mode');
    formContainer.classList.remove('manual-mode', 'auto-mode', 'error-mode');
    
    if (modo === 'auto') {
      formContainer.classList.add('auto-mode');
      modoBadge.textContent = 'Registro Autom√°tico';
      modoBadge.className = 'badge bg-success';
      btnRegistrar.disabled = true;
      btnRegistrar.innerHTML = '<span style="font-size: 1.2rem;">ü§ñ</span> Registro Autom√°tico';
    } else {
      formContainer.classList.add('manual-mode');
      modoBadge.textContent = 'Modo Manual';
      modoBadge.className = 'badge bg-warning';
      btnRegistrar.disabled = false;
      btnRegistrar.innerHTML = '<span style="font-size: 1.2rem;">‚úì</span> Registrar Manual';
    }
    
    // Restaurar modo apoyo si aplica
    if (esApoyo) {
      formContainer.classList.add('apoyo-mode');
    }
  }

  // Funci√≥n para testear c√≥digos
  function testCode(codigo) {
    mostrarNotificacion(`Probando c√≥digo: ${codigo}`, 'info');
    
    // Simular entrada manual
    document.getElementById('barcodeInput').value = codigo;
    
    // Procesar el c√≥digo
    procesarCodigoBarras(codigo);
    
    // Efecto visual en el esc√°ner
    const scannerContainer = document.getElementById('scannerContainer');
    scannerContainer.style.borderColor = '#198754';
    scannerContainer.style.boxShadow = '0 0 15px rgba(25, 135, 84, 0.5)';
    
    setTimeout(() => {
      scannerContainer.style.borderColor = '#0d6efd';
      scannerContainer.style.boxShadow = 'none';
    }, 1000);
  }

  // Funci√≥n para limpiar formulario
  function limpiarFormulario() {
    document.getElementById('camionForm').reset();
    limpiarErrorDuplicado();
    cambiarModoRegistro('manual');
    
    // Limpiar estilos especiales
    const formContainer = document.getElementById('camionForm').parentElement;
    const tipoApoyoIndicator = document.getElementById('tipoApoyoIndicator');
    const inputRuta = document.getElementById('nombreRuta');
    const inputTipoCarga = document.getElementById('tipoCarga');
    
    formContainer.classList.remove('apoyo-mode');
    tipoApoyoIndicator.classList.add('d-none');
    inputRuta.style.backgroundColor = '';
    inputRuta.style.borderColor = '';
    inputTipoCarga.style.backgroundColor = '';
    inputTipoCarga.style.borderColor = '';
    
    mostrarNotificacion('Formulario limpiado', 'info');
  }

  // Funci√≥n para mostrar notificaci√≥n
  function mostrarNotificacion(mensaje, tipo = 'success') {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${tipo} shadow-lg position-fixed`;
    alertDiv.style.cssText = `
      top: 20px;
      right: 20px;
      z-index: 1000;
      animation: slideIn 0.3s ease-out, fadeOut 0.5s ease-out 2.5s forwards;
      border-radius: 0.5rem;
      min-width: 300px;
    `;
    
    let icono = '‚úì';
    if (tipo === 'warning') icono = '‚ö†Ô∏è';
    if (tipo === 'info') icono = '‚ÑπÔ∏è';
    if (tipo === 'danger') icono = '‚ùå';
    
    alertDiv.innerHTML = `
      <div class="d-flex align-items-center">
        <span style="font-size: 1.5rem; margin-right: 10px;">${icono}</span>
        <span>${mensaje}</span>
      </div>
    `;
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
      if (alertDiv.parentNode) {
        alertDiv.remove();
      }
    }, 3000);
  }

  // Funci√≥n para registrar un cami√≥n
  function registrarCamion(datos, esAutomatico = false) {
    const { numeroCamion, nombreRuta, carril, tipoCarga } = datos;
    const horaLlegada = new Date().toLocaleTimeString();

    // Validaciones b√°sicas
    if (!numeroCamion || !nombreRuta || !carril) {
      const mensaje = esAutomatico ? 
        'Error en c√≥digo: Faltan datos. Complete manualmente.' : 
        'Faltan datos requeridos';
      mostrarNotificacion(mensaje, 'danger');
      return false;
    }

    // Verificar duplicado (segunda verificaci√≥n por seguridad)
    const duplicado = verificarDuplicado(numeroCamion);
    if (duplicado) {
      mostrarErrorDuplicado(duplicado, esAutomatico);
      return false;
    }

    // Crear nuevo cami√≥n
    const nuevoCamion = {
      numeroCamion,
      nombreRuta,
      carril,
      horaLlegada,
      carta: tipoCarga || "‚Äî",
      horaSalida: "‚Äî"
    };

    // Obtener camiones existentes
    const camiones = JSON.parse(localStorage.getItem("camiones") || "[]");
    
    // Agregar nuevo cami√≥n
    camiones.push(nuevoCamion);
    localStorage.setItem("camiones", JSON.stringify(camiones));

    // Mostrar notificaci√≥n especial seg√∫n tipo
    const letraCarril = mapaCarriles[carril] || carril;
    let mensaje = '';
    let tipoNotificacion = 'success';
    
    if (esTipoApoyo(tipoCarga)) {
      mensaje = `üî¥ CAMI√ìN DE APOYO #${numeroCamion} registrado en Carril ${letraCarril}`;
      tipoNotificacion = 'danger';
    } else if (esRutaSantaFe3(nombreRuta)) {
      mensaje = `üü¢ Ruta Santa Fe 3: Cami√≥n #${numeroCamion} registrado en Carril ${letraCarril}`;
    } else {
      mensaje = esAutomatico ? 
        `‚úÖ Cami√≥n ${numeroCamion} registrado AUTOM√ÅTICAMENTE en Carril ${letraCarril}` :
        `‚úÖ Cami√≥n ${numeroCamion} registrado manualmente en Carril ${letraCarril}`;
    }
    
    mostrarNotificacion(mensaje, tipoNotificacion);

    // Actualizar tabla
    actualizarTabla();

    // Limpiar formulario si fue autom√°tico
    if (esAutomatico) {
      setTimeout(() => {
        limpiarFormulario();
      }, 1000);
    } else {
      // Solo limpiar el n√∫mero para permitir nuevo registro
      document.getElementById('numeroCamion').value = '';
    }
    
    return true;
  }

  // Funci√≥n para actualizar la tabla
  function actualizarTabla() {
    const camiones = JSON.parse(localStorage.getItem("camiones") || "[]");
    const tablaBody = document.getElementById("tablaBody");
    const emptyMessage = document.getElementById("emptyMessage");
    
    // Limpiar tabla
    tablaBody.innerHTML = "";
    
    if (camiones.length === 0) {
      emptyMessage.style.display = 'block';
      return;
    }
    
    emptyMessage.style.display = 'none';
    
    // Ordenar camiones por hora de llegada (m√°s recientes primero)
    camiones.sort((a, b) => new Date(b.horaLlegada) - new Date(a.horaLlegada));
    
    // Contadores para estad√≠sticas
    let contadorSantaFe3 = 0;
    let contadorApoyo = 0;
    
    // Agregar filas
    camiones.forEach((camion, index) => {
      // Verificar si pasa el filtro activo
      let mostrarFila = true;
      if (filtroActivo === 'santa-fe-3' && !esRutaSantaFe3(camion.nombreRuta)) {
        mostrarFila = false;
      }
      if (filtroActivo === 'apoyo' && !esTipoApoyo(camion.carta)) {
        mostrarFila = false;
      }
      
      if (!mostrarFila) return;
      
      // Actualizar contadores
      if (esRutaSantaFe3(camion.nombreRuta)) contadorSantaFe3++;
      if (esTipoApoyo(camion.carta)) contadorApoyo++;
      
      const fila = document.createElement("tr");
      const letraCarril = mapaCarriles[camion.carril] || camion.carril;
      const estaActivo = camion.horaSalida === "‚Äî";
      
      // Aplicar clases especiales
      let clasesEspeciales = '';
      if (esRutaSantaFe3(camion.nombreRuta)) {
        clasesEspeciales += ' ruta-santa-fe-3';
      }
      if (esTipoApoyo(camion.carta)) {
        clasesEspeciales += ' tipo-apoyo';
      }
      
      fila.className = clasesEspeciales;
      
      fila.innerHTML = `
        <td>${index + 1}</td>
        <td><strong>${camion.numeroCamion}</strong></td>
        <td>
          ${camion.nombreRuta}
          ${esRutaSantaFe3(camion.nombreRuta) ? '<span class="badge badge-ruta-especial ms-1">SF3</span>' : ''}
        </td>
        <td><span class="badge-carril">${letraCarril}</span></td>
        <td>
          ${camion.carta || '‚Äî'}
          ${esTipoApoyo(camion.carta) ? '<span class="badge badge-tipo-apoyo ms-1">APOYO</span>' : ''}
        </td>
        <td>${camion.horaLlegada}</td>
        <td>${camion.horaSalida || '‚Äî'}</td>
        <td>
          <span class="badge ${estaActivo ? 'bg-success' : 'bg-secondary'}">
            ${estaActivo ? 'Activo' : 'Completado'}
          </span>
        </td>
        <td>
          <button class="btn btn-sm ${estaActivo ? "btn-outline-primary" : "btn-success"}" 
                  onclick="registrarSalida(${camiones.indexOf(camion)})"
                  ${!estaActivo ? "disabled" : ""}>
            ${estaActivo ? "üöÄ Salida" : "‚úÖ Completado"}
          </button>
        </td>
      `;
      tablaBody.appendChild(fila);
    });
    
    // Actualizar t√≠tulo con estad√≠sticas
    const tituloTabla = document.querySelector('.card-header span');
    if (filtroActivo === 'todos') {
      tituloTabla.textContent = `üìã Historial de Llegadas (${camiones.length} camiones)`;
    } else if (filtroActivo === 'santa-fe-3') {
      tituloTabla.textContent = `üü¢ Ruta Santa Fe 3 (${contadorSantaFe3} camiones)`;
    } else if (filtroActivo === 'apoyo') {
      tituloTabla.textContent = `üî¥ Camiones de Apoyo (${contadorApoyo} camiones)`;
    }
  }

  // Funciones de filtrado
  function filtrarRutaSantaFe3() {
    filtroActivo = 'santa-fe-3';
    actualizarTabla();
    mostrarNotificacion('Mostrando solo camiones de la ruta Santa Fe 3', 'info');
  }

  function filtrarTipoApoyo() {
    filtroActivo = 'apoyo';
    actualizarTabla();
    mostrarNotificacion('Mostrando solo camiones de tipo Apoyo', 'warning');
  }

  function quitarFiltros() {
    filtroActivo = 'todos';
    actualizarTabla();
    mostrarNotificacion('Mostrando todos los camiones', 'info');
  }

  // Funci√≥n para registrar salida
  function registrarSalida(index) {
    const camiones = JSON.parse(localStorage.getItem("camiones") || "[]");
    
    if (camiones[index]) {
      const horaSalida = new Date().toLocaleTimeString();
      camiones[index].horaSalida = horaSalida;
      localStorage.setItem("camiones", JSON.stringify(camiones));
      
      mostrarNotificacion(`‚úÖ Salida registrada para cami√≥n ${camiones[index].numeroCamion}`);
      actualizarTabla();
    }
  }

  // Funci√≥n para limpiar historial
  function limpiarHistorial() {
    if (confirm("¬øEst√°s seguro de que quieres limpiar todo el historial? Esta acci√≥n no se puede deshacer.")) {
      localStorage.removeItem("camiones");
      mostrarNotificacion('Historial limpiado correctamente', 'warning');
      actualizarTabla();
    }
  }

  // Funci√≥n para exportar datos
  function exportarDatos() {
    const camiones = JSON.parse(localStorage.getItem("camiones") || "[]");
    
    if (camiones.length === 0) {
      mostrarNotificacion('No hay datos para exportar', 'warning');
      return;
    }
    
    // Convertir a CSV
    let csv = 'N√∫mero,Ruta,Carril,Tipo Carga,Llegada,Salida,Estado\n';
    camiones.forEach(camion => {
      const letraCarril = mapaCarriles[camion.carril] || camion.carril;
      const estado = camion.horaSalida === "‚Äî" ? "Activo" : "Completado";
      csv += `"${camion.numeroCamion}","${camion.nombreRuta}","${letraCarril}","${camion.carta || ''}","${camion.horaLlegada}","${camion.horaSalida || ''}","${estado}"\n`;
    });
    
    // Crear archivo
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `camiones_${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
    
    mostrarNotificacion('Datos exportados correctamente');
  }

  // Evento submit del formulario (registro manual)
  document.getElementById("camionForm").addEventListener("submit", function(e) {
    e.preventDefault();

    const numeroCamion = document.getElementById("numeroCamion").value.trim();
    const nombreRuta = document.getElementById("nombreRuta").value.trim();
    const carril = document.getElementById("carril").value;
    const tipoCarga = document.getElementById("tipoCarga").value.trim();

    const datos = {
      numeroCamion,
      nombreRuta,
      carril,
      tipoCarga
    };

    registrarCamion(datos, false);
  });

  // Detectar cambios en el tipo de carga para aplicar estilos
  document.getElementById('tipoCarga').addEventListener('input', function() {
    const tipoCarga = this.value.trim();
    const nombreRuta = document.getElementById('nombreRuta').value.trim();
    aplicarEstilosFormulario(tipoCarga, nombreRuta);
  });

  // Detectar cambios en la ruta para aplicar estilos
  document.getElementById('nombreRuta').addEventListener('input', function() {
    const nombreRuta = this.value.trim();
    const tipoCarga = document.getElementById('tipoCarga').value.trim();
    aplicarEstilosFormulario(tipoCarga, nombreRuta);
  });

  // Entrada manual de c√≥digo de barras
  document.getElementById('barcodeInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      e.preventDefault();
      const codigo = this.value.trim();
      if (codigo) {
        handleScannedCode(codigo);
        this.value = '';
      }
    }
  });

  // Detectar cambios en el n√∫mero de cami√≥n para verificar duplicados en tiempo real
  document.getElementById('numeroCamion').addEventListener('input', function() {
    const numero = this.value.trim();
    if (numero) {
      verificarDuplicadoEnTiempoReal(numero);
    } else {
      limpiarErrorDuplicado();
    }
    
    // Cambiar a modo manual si se edita
    if (modoActual === 'auto') {
      cambiarModoRegistro('manual');
      mostrarNotificacion('Modo cambiado a manual. Presione "Registrar Manual".', 'info');
    }
  });

  // Detectar cambios manuales en otros campos
  document.querySelectorAll('#carril').forEach(element => {
    element.addEventListener('input', function() {
      if (modoActual === 'auto') {
        cambiarModoRegistro('manual');
        mostrarNotificacion('Modo cambiado a manual. Presione "Registrar Manual".', 'info');
      }
    });
  });

  // Inicializar la aplicaci√≥n al cargar
  document.addEventListener('DOMContentLoaded', function() {
    initScanner();
    actualizarTabla();
    
    // Poner foco en el input de c√≥digo de barras
    document.getElementById('barcodeInput').focus();
    
    // Detener el esc√°ner al salir de la p√°gina
    window.addEventListener('beforeunload', stopScanner);
  });
</script>
</body>
</html>